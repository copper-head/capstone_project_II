# fn-6-m69.4 Pipeline integration: context fetch before LLM, index-based correlation

## Description
Modify the pipeline to fetch calendar context BEFORE the LLM call and pass it through. Replace the fragile title-based event correlation with index-based correlation.

**Files to modify:**
- `src/cal_ai/pipeline.py` — Move `GoogleCalendarClient` construction before Stage 2 (LLM extraction). Add calendar context fetch. Pass context to `extract_events()`. Replace `{v.title: v}` mapping (line ~319-320) with index-based correlation.
- `src/cal_ai/llm.py` — Add `calendar_context: str = ""` parameter to `extract_events()`. Pass to `build_system_prompt()`.
- `tests/unit/test_pipeline.py` — Update pipeline mocks for new flow.
- `tests/unit/llm/test_gemini.py` — Update extraction tests for calendar_context param.

**Pipeline flow change:**
```
BEFORE: parse → extract → [build client] → sync
AFTER:  parse → [build client] → fetch context → extract(with context) → sync
```

**Key changes:**
1. In `run_pipeline()`, construct `GoogleCalendarClient` in Stage 1 (after parse, before extract).
2. Call `fetch_calendar_context(client, now)` to get calendar context.
3. Pass `calendar_context.events_text` to `gemini.extract_events()`.
4. Store `calendar_context.id_map` for use in sync stage (reverse-map `existing_event_id` integers to real UUIDs).
5. In `_validate_events()`, replace title-based dict with index-based: zip extracted events with validated events by position.
6. In dry-run mode, still fetch context but skip sync (existing behavior preserved).

**Key decisions:**
- If credential fetch fails early, fall back to extraction WITHOUT calendar context (graceful degradation).
- Index-based correlation: `validated_events[i]` corresponds to `extracted_events[i]` — no title matching needed.
## Acceptance
- [ ] Calendar client constructed before LLM extraction stage
- [ ] `fetch_calendar_context()` called and context passed to extractor
- [ ] `extract_events()` accepts and uses `calendar_context` parameter
- [ ] Index-based event correlation replaces title-based mapping
- [ ] `id_map` stored for sync stage reverse lookup
- [ ] Graceful degradation when credentials unavailable (extract without context)
- [ ] Dry-run still works (fetches context, skips sync)
- [ ] All existing pipeline tests updated and passing
- [ ] ruff clean
## Done summary
Integrated calendar context fetching before LLM extraction in the pipeline. Calendar client is now constructed early, context is fetched and passed to extract_events(), and index-based event correlation replaces the fragile title-based mapping. Graceful degradation when credentials are unavailable.
## Evidence
- Commits: ef9791b2999b0ebaf60533effa4610c5813e5c4b
- Tests: python3 -m pytest --tb=short -q (289 passed), python3 -m ruff check . (All checks passed)
- PRs: