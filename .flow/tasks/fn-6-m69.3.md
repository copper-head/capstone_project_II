# fn-6-m69.3 Enhanced system prompt with CRUD intelligence & few-shot examples

## Description
Rewrite `build_system_prompt()` in `src/cal_ai/prompts.py` with comprehensive CRUD decision rules, few-shot examples, negative examples, and a calendar context section.

**Files to modify:**
- `src/cal_ai/prompts.py` — Major rewrite of `build_system_prompt()` (line 14-110). Add `calendar_context: str = ""` parameter.

**Files to modify (tests):**
- `tests/unit/test_prompts.py` — Update and expand prompt tests.

**Prompt structure (in order):**
1. Role & task description (existing, refine)
2. CRUD decision rules:
   - **CREATE**: No matching event in calendar context. Default action when uncertain.
   - **UPDATE**: Conversation references a specific existing event AND proposes changes to it. Must include `existing_event_id`.
   - **DELETE**: Conversation explicitly or implicitly cancels an existing event. Must include `existing_event_id`. Signals: "cancel", "remove", "not happening", "skip it", "won't make it".
3. Confidence guidance (asymmetric): create=medium OK, update/delete=high only when clear match.
4. Few-shot examples (2-3): one create, one update with existing event match, one delete with implicit cancellation.
5. Negative examples (1-2): "do NOT update when..." (e.g., similar title but clearly different event).
6. Calendar context section (injected at end of prompt, after examples): `## Your Calendar\n{calendar_context}`
7. Output schema reminder.

**Key decisions:**
- Last-statement-wins: prompt instructs AI to use final version when conversation has conflicting instructions.
- `existing_event_id` references integer IDs from calendar context (not UUIDs).
- Place calendar context near end (lost-in-the-middle effect).
## Acceptance
- [ ] `build_system_prompt()` accepts `calendar_context: str = ""` parameter
- [ ] CRUD decision rules clearly defined in prompt
- [ ] Asymmetric confidence guidance (create=medium, update/delete=high)
- [ ] At least 2 few-shot examples (create + update or delete)
- [ ] At least 1 negative example
- [ ] Calendar context placed near end of prompt
- [ ] Last-statement-wins instruction present
- [ ] All existing prompt tests updated + new tests for CRUD rules
- [ ] ruff clean
## Done summary
TBD

## Evidence
- Commits:
- Tests:
- PRs:
